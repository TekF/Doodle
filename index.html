<!DOCTYPE html>
<html>
  <head>
	<meta charset="UTF-8">
    <title>Doodle</title>
  </head>
  <body>
   
    <canvas id="myCanvas" width="256" height="256" style="border:1px solid #d3d3d3;">Your browser does not support the HTML5 canvas tag.</canvas>
    <p id="status"></p>
    
    <img id="image">

    <script src="jsgif/b64.js"></script>
    <script src="jsgif/LZWEncoder.js"></script>
    <script src="jsgif/NeuQuant.js"></script>
    <script src="jsgif/GIFEncoder.js"></script>

    <script>
      var plum = document.getElementById("status");
	  plum.innerHTML = "Initialising...";

	  var numFrames = 10;
	  
	  var frame = 0;
      var c = document.getElementById("myCanvas");
      var ctx = c.getContext("2d");
      
      function Draw()
      {
		var p = 3*frame;
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, c.width, c.height);
        ctx.fillStyle = "#ff0000";
        ctx.fillRect(p,p,128,128);
		
        console.log(encoder.addFrame(ctx));
		
		frame++;
/*		if ( frame < numFrames )
		{
		this breaks gif encoding - probably because it's on another thread => we probably don't need this because single thread should wait
			window.requestAnimationFrame(Draw);
		}*/
      }
      
      var encoder = new GIFEncoder();
      encoder.setRepeat(0); //auto-loop
      encoder.setDelay(100);
      console.log(encoder.start());

      plum.innerHTML = "Generating...";

	  while( frame < numFrames )
	  {
		Draw();
	  }
      
      encoder.finish();
      plum.innerHTML = "Done.";
      document.getElementById('image').src = 'data:image/gif;base64,'+encode64(encoder.stream().getData())
    </script>
  </body>
</html>
